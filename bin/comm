#!/usr/bin/env ruby

require 'bundler/setup'
require 'comm'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: comm [options]"

  opts.on('-k', '--key <KEY>', String, 'A pub/private key pem file') do |v|
    options[:keyfile] = v
  end

  opts.on('-p', '--port <PORT>', Integer, 'Port to listen on') do |v|
    options[:port] = v
  end

  opts.on("-b", "--bootstrap <HOST:PORT>", String, "Add a bootstrap connection") do |v|
    options[:bootstrap] = v
  end
end.parse!

if keyfile = options[:keyfile]
  key = OpenSSL::PKey::RSA.new(File.read(keyfile))
else
  key = OpenSSL::PKey::RSA.open(4096)
end

port = Integer(options.fetch(:port) { 6000 })
node = Comm::Node.new('0.0.0.0', port, key: key)
client = Comm::CliClient.new(node)

node.async.run

if bootstrap = options[:bootstrap]
  host, port = bootstrap.split(':')
  node.async.connect_to(host, port)
end

client.run
