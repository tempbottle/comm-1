#!/usr/bin/env ruby

require 'bundler/setup'
require 'comm'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: comm [options]"

  opts.on('-s', '--secret <PHRASE>', String, 'Your secret') do |v|
    options[:secret] = v
  end

  opts.on('-p', '--port <PORT>', Integer, 'Port to listen on') do |v|
    options[:port] = v
  end

  opts.on("-b", "--bootstrap <HOST:PORT>", String, "Add a bootstrap connection") do |v|
    options[:bootstrap] = v
  end
end.parse!

port = Integer(options.fetch(:port) { 6000 })
secret = options.fetch(:secret) { 'not secret' }
node = Comm::Node.new('0.0.0.0', port, secret: secret)
node.async.run

if bootstrap = options[:bootstrap]
  host, port = bootstrap.split(':')
  node.async.connect_to(host, port)
end

loop do
  print '> '
  recipient, text = gets.chomp.split(': ')
  message = Comm::Messages::Chat.new(
    address: Comm::Address.for_content(recipient + text).to_s,
    recipient: recipient,
    text: text)
  node.broadcast(message)
end
